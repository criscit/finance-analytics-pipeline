version: 2

models:
  - name: core_t_bank_transactions
    description: >
      Core fact table for bank transactions with business key and incremental processing.
      This table contains the main transaction data with a composite business key for deduplication.
    tags: [core, t_bank, fact]
    meta:
      materialization: incremental
      incremental_strategy: merge
      unique_key: transaction_bk

    columns:
      - name: transaction_bk
        description: Business key for the transaction, generated from MD5 hash of key fields.
        data_type: varchar(32)
        data_tests:
          - not_null
          - unique

      - name: card_last4
        description: Last 4 digits of the card used for the transaction.
        data_type: varchar(5)

      - name: status_nm
        description: Bank-provided status of the transaction.
        data_type: varchar(10)
        data_tests:
          - accepted_values:
              values: ['OK', 'FAILED']
          - not_null

      - name: category_nm
        description: Bank-assigned spending category label.
        data_type: varchar(128)

      - name: description
        description: Free-text operation description from the bank export.
        data_type: varchar(256)

      - name: transaction_amt
        description: Amount actually charged/posted, in transaction currency.
        data_type: double
        data_tests:
          - not_null

      - name: transaction_currency_cd
        description: ISO-like currency code of the posted transaction.
        data_type: varchar(3)
        data_tests:
          - accepted_values:
              values: ['RUB']
              severity: warn
          - not_null

      - name: transacted_at_utc
        description: Timestamp of the transaction with UTC timezone.
        data_type: timestamp
        data_tests:
          - not_null

      - name: total_rewards_amt
        description: Total rewards for the transaction, including cashback.
        data_type: double

      - name: __ingested_at
        description: Timestamp of the ingestion for incremental processing.
        data_type: timestamp
        data_tests:
          - not_null
