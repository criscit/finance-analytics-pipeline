# file: docker-compose.yml
services:
  worker:
    build:
      context: .
      dockerfile: infra/Dockerfile
    environment:
      - DAGSTER_HOME=${DAGSTER_HOME}
      - RAW_PATH=${RAW_PATH}
      - DUCKDB_PATH=${DUCKDB_PATH}
      - EXPORT_CSV_PATH=${EXPORT_CSV_PATH}
      - EXPORT_META_PATH=${EXPORT_META_PATH}
      - RAW_STABILITY_SECONDS=${RAW_STABILITY_SECONDS}
      - GOOGLE_SA_JSON=${GOOGLE_SA_JSON}
      - GOOGLE_SHEET_ID=${GOOGLE_SHEET_ID}
      - GOOGLE_SHEET_RANGE=${GOOGLE_SHEET_RANGE}
      - EXPORT_TABLE=${EXPORT_TABLE}
      - DBT_DIR=${DBT_DIR}
      - DBT_PROFILES_DIR=${DBT_PROFILES_DIR}
    volumes:
      # Inputs: default to ./sample_data if INPUT_FINANCE_PATH is not set
      - type: bind
        source: ${INPUT_FINANCE_PATH:-./sample_data}
        target: /app/data/raw

      # Exports: keep parent-less, explicit targets to avoid overlap
      - type: bind
        source: ${EXPORT_CSV_PATH:-./data/exports/csv}
        target: /app/data/exports/csv
      - type: bind
        source: ${EXPORT_META_PATH:-./data/exports/metadata}
        target: /app/data/exports/metadata

      # Project code & state
      - type: bind
        source: ./orchestration
        target: /app/orchestration
      - type: bind
        source: ./transform
        target: /app/transform
      - type: bind
        source: ./quality
        target: /app/quality
      - type: bind
        source: ./docs
        target: /app/docs
      - type: bind
        source: ./data/warehouse
        target: /app/data/warehouse
      - type: bind
        source: ./data/dagster_home
        target: /app/dagster_home
      - type: bind
        source: ./credentials
        target: /app/credentials
        read_only: true
    command: bash -lc "dagster dev -h 0.0.0.0 -p 3000 --workspace /app/workspace.yaml"
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "bash", "-lc", "python -c 'import duckdb;print(1)'"]
      interval: 15s
      timeout: 5s
      retries: 10
